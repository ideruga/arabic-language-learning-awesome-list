<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Arabic Typing Trainer â€” Neon Prototype</title>
  <style>

    /* --- Theme ------------------------------------------------------------ */
    :root{
      --bg:#0a0b12;            /* deep space */
      --panel:#0f1220;
      --text:#d9e2ff;          /* soft neon ink */
      --muted:#9fb1ff;
      --accent:#68f0ff;        /* cyan glow */
      --accent-2:#b06bff;      /* purple glow */
      --ok:#23d18b;            /* green */
      --bad:#ff4d6d;           /* pink-red */
      --key:#15182a;
      --key-edge:#20263d;
      --radius:18px;
      --shadow:0 0 12px rgba(104,240,255,.35), 0 0 24px rgba(176,107,255,.25);
    }

    html, body { height: 100%; }
    body{
      margin:0; padding:18px; color:var(--text);
      background: radial-gradient(1200px 600px at 70% -20%, rgba(176,107,255,.12), transparent),
                  radial-gradient(800px 600px at -10% 120%, rgba(104,240,255,.10), transparent),
                  var(--bg);
      font-family: "Fira Code", Consolas, "Courier New", monospace;
      display:grid; grid-template-rows:auto auto 1fr auto; gap:14px;
    }

    h1{margin:0; text-shadow:0 0 12px rgba(176,107,255,.45)}

    .bar{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(176,107,255,.07), rgba(104,240,255,.05));
      border:1px solid rgba(175, 180, 255, .18);
      border-radius:var(--radius);
      padding:12px 14px; box-shadow:var(--shadow);
    }
    .bar label{font-size:14px; color:var(--muted)}
    .bar select, .bar button{
      background:var(--panel); color:var(--text);
      border:1px solid var(--key-edge); border-radius:12px;
      padding:8px 12px; cursor:pointer;
      transition: box-shadow .15s ease, transform .06s ease;
    }
    .bar button:hover, .bar select:hover{ box-shadow:0 0 0 2px rgba(104,240,255,.25) }
    .bar button:active{ transform: translateY(1px) }

    .console{
      display:grid; gap:10px;
      background: linear-gradient(180deg, rgba(13,16,30,.8), rgba(13,16,30,.6));
      border:1px solid rgba(175, 180, 255, .12);
      border-radius:var(--radius);
      padding:16px; box-shadow:var(--shadow);
    }

    .target{
      font-size: clamp(22px, 4.3vw, 36px);
      line-height: 1.8; direction: rtl;
      background: var(--panel);
      border: 1px dashed rgba(104,240,255,.25);
      padding: 16px; border-radius: 12px; min-height: 72px;
      text-align: center;
      word-wrap: break-word;
    }
    .cursor{ position:relative; display:inline-block; min-width:1ch; border-bottom:2px solid var(--accent); box-shadow:0 2px 12px rgba(104,240,255,.5); animation:pulse 1.2s ease-in-out infinite; }
    @keyframes pulse{0%,100%{opacity:.7}50%{opacity:1}}

    .progress { height: 10px; width:100%; background:#0c0f18; border-radius:8px; border:1px solid rgba(104,240,255,.18); overflow:hidden }
    .progress > div{ height:100%; width:0; background: linear-gradient(90deg, var(--accent), var(--accent-2)); }

    .stats{ display:flex; gap:14px; flex-wrap:wrap; font-size:14px }
    .pill{ background: rgba(104,240,255,.08); padding:6px 10px; border:1px solid rgba(104,240,255,.22); border-radius:999px }

    .kbd { display:grid; gap:10px; }
    .row { display:grid; grid-auto-flow:column; gap:8px; justify-content:center; }
    .key{
      user-select:none; min-width:38px; height:46px;
      padding:4px 10px; display:flex; align-items:center; justify-content:center;
      background: radial-gradient(80% 140% at 30% 20%, rgba(176,107,255,.15), transparent), var(--key);
      border:1px solid var(--key-edge); border-radius:12px; position:relative;
      box-shadow: inset 0 0 10px rgba(0,0,0,.25);
      transition: transform .05s ease, box-shadow .15s ease, border-color .15s ease, background .2s ease;
      font-size:18px;
    }
    .key.glow { box-shadow: 0 0 12px rgba(104,240,255,.45), inset 0 0 10px rgba(104,240,255,.1); border-color: rgba(104,240,255,.55); }
    .key.press { transform: translateY(2px); }
    .key.ok { background: radial-gradient(80% 120% at 50% 10%, rgba(35,209,139,.28), transparent), var(--key); border-color: rgba(35,209,139,.65); box-shadow: 0 0 12px rgba(35,209,139,.45); }
    .key.bad { background: radial-gradient(80% 120% at 50% 10%, rgba(255,77,109,.25), transparent), var(--key); border-color: rgba(255,77,109,.6); box-shadow: 0 0 12px rgba(255,77,109,.45); }

    .footer{opacity:.7; font-size:12px; text-align:center}

    /* Progressive Letter Pair Display */
    .pair-display {
      background: var(--panel); color: var(--text);
      border: 1px solid var(--key-edge); border-radius: 12px;
      padding: 8px 12px;
      cursor: pointer;
      transition: box-shadow .15s ease, transform .06s ease;
      width: 280px;
      position: relative;
    }
    .pair-display:hover {
      box-shadow: 0 0 0 2px rgba(104,240,255,.25);
    }

    /* Progressive Letter Pair Selector */
    .pair-selector {
      display: none; /* Hidden by default */
      position: absolute;
      top: 0;
      left: 0;
      width: 280px;
      /*max-height: 500px;*/
      overflow-y: auto;
      background: var(--panel);
      border: 1px solid var(--key-edge);
      border-radius: 12px;
      padding: 12px;
      gap: 8px;
      z-index: 20;
      box-shadow: 0 4px 16px rgba(104,240,255,.2);
    }
    .pair-selector.show {
      display: grid;
    }
    .pair-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 12px; border-radius: 8px; cursor: pointer;
      background: rgba(104,240,255,.05);
      border: 1px solid rgba(104,240,255,.15);
      transition: all .2s ease;
    }
    .pair-item:hover, .pair-item.active {
      background: rgba(104,240,255,.12);
      border-color: rgba(104,240,255,.35);
      box-shadow: 0 0 8px rgba(104,240,255,.25);
    }
    .pair-item.selected {
      background: rgba(104,240,255,.18);
      border-color: rgba(104,240,255,.55);
      box-shadow: 0 0 12px rgba(104,240,255,.35);
    }
    .pair-name {
      font-size: 18px; font-weight: bold;
      color: var(--text); direction: rtl;
    }
    .pair-desc {
      font-size: 12px; color: var(--muted);
      text-align: right;
    }
  </style>
</head>
<body>
  <h1>Arabic Typing Trainer â€” Prototype</h1>

  <!-- Controls / Menus -->
  <div class="bar" role="toolbar" aria-label="controls">
    <label> Mode
      <select id="mode">
        <option value="letters">Letters</option>
        <option value="words">Words</option>
        <option value="texts">Texts</option>
      </select>
    </label>
    <label> Lesson
      <select id="lesson"></select>
    </label>
    <div id="pairDisplay" class="pair-display"></div>
    <div id="pairSelector" class="pair-selector">blah</div>
    <label> Length
      <select id="length">
        <option value="20">20</option>
        <option value="40" selected>40</option>
        <option value="80">80</option>
      </select>
    </label>
    <button id="startBtn">Start</button>
    <button id="pauseBtn">Pause</button>
    <button id="resetBtn">Reset</button>
  </div>

  <!-- Console / Exercise -->
  <div class="console">
    <div id="textDisplay" class="target" dir="rtl">Press "Start" to begin.</div>
  </div>

  <!-- Virtual Keyboard -->
  <div class="console">
    <div id="keyboard" class="kbd"></div>
  </div>

  <!-- Stats -->
  <div class="console">
    <div class="stats">
      <div class="pill">Accuracy: <span id="acc">0%</span></div>
      <div class="pill">WPM: <span id="wpm">0</span></div>
      <div class="pill">Hits: <span id="hits">0</span></div>
      <div class="pill">Misses: <span id="miss">0</span></div>
      <div class="pill">Time: <span id="timer">0.0s</span></div>
    </div>
  </div>

  <footer class="footer">Neon UI â€¢ Maintainable JS â€¢ Extensible lessons (letters â†’ words â†’ texts)</footer>

  <script>
  // ======================================================================
  //  Arabic Typing Trainer â€” Full Prototype (Menus + Stats + Key Preview)
  //  â€¢ English keyboard â†’ Arabic mapping (no OS language switch needed)
  //  â€¢ Neon virtual keyboard with correctness glow & next-letter preview
  //  â€¢ Modes: letters / words / texts (sample data for words/texts)
  //  â€¢ Clean state & rendering logic, easy to extend
  // ======================================================================

  // Visual Arabic keyboard rows (for highlighting only)
  const ARABIC_KEYBOARD_ROWS = [
    ["Ø¶","Øµ","Ø«","Ù‚","Ù","Øº","Ø¹","Ù‡","Ø®","Ø­","Ø¬","Ø¯"],
    ["Ø´","Ø³","ÙŠ","Ø¨","Ù„","Ø§","Øª","Ù†","Ù…","Ùƒ","Ø·"],
    ["Ø¦","Ø¡","Ø¤","Ø±","Ù„Ø§","Ù‰","Ø©","Ùˆ","Ø²","Ø¸"]
  ];

  // Mapping from EN keys to Arabic glyphs
  const KEYMAP = {
    'q':'Ø¶','w':'Øµ','e':'Ø«','r':'Ù‚','t':'Ù','y':'Øº','u':'Ø¹','i':'Ù‡','o':'Ø®','p':'Ø­','[':'Ø¬',
    'a':'Ø´','s':'Ø³','d':'ÙŠ','f':'Ø¨','g':'Ù„','h':'Ø§','j':'Øª','k':'Ù†','l':'Ù…',';':'Ùƒ','\'':'Ø·',
    'z':'Ø¦','x':'Ø¡','c':'Ø¤','v':'Ø±','b':'Ù„Ø§','n':'Ù‰','m':'Ø©',',':'Ùˆ','.':'Ø²','/':'Ø¸','`':'Ø¯','-':'âˆ’','=':'=' , ' ':' '
  };

  // Progressive Letter Pairs System (based on finger positioning)
  const LETTER_PAIRS = [
    { name: 'Øª-Ø¨', chars: ['Øª', 'Ø¨'], fingers: 'Index fingers (home row)' },
    { name: 'Ø§-Ù„', chars: ['Ø§', 'Ù„'], fingers: 'Index fingers (home row)' },
    { name: 'Øª-ÙŠ', chars: ['Ù†', 'ÙŠ'], fingers: 'Middle fingers (home row)' },
    { name: 'Ù…-Ø³', chars: ['Ù…', 'Ø³'], fingers: 'Ring fingers (home row)' },
    { name: 'Ùƒ-Ø´', chars: ['Ùƒ', 'Ø´'], fingers: 'Pinky fingers (home row)' },
    { name: 'Ø·', chars: ['Ø·'], fingers: 'Pinky fingers Ext (home row)' },

    { name: 'Ø¹-Ù‚', chars: ['Ø¹', 'Ù‚'], fingers: 'Index fingers (upper row)' },
    { name: 'Øº-Ù', chars: ['Øº', 'Ù'], fingers: 'Index fingers (upper row)' },
    { name: 'Ù‡-Ø«', chars: ['Ù‡', 'Ø«'], fingers: 'Middle fingers (upper row)' },
    { name: 'Ø®-Øµ', chars: ['Ø®', 'Øµ'], fingers: 'Ring fingers (upper row)' },
    { name: 'Ø¬-Ø­-Ø¶', chars: ['Ø­', 'Ø¶', 'Ø¬'], fingers: 'Pinky fingers (upper row)' },
    { name: 'Ø¯-Ø°', chars: ['Ø¯', 'Ø°'], fingers: 'Pinky fingers Ext (upper row)' },

    { name: 'Ø©-Ø±', chars: ['Ø©', 'Ø±'], fingers: 'Index fingers (lower row)' },
    { name: 'Ù‰-Ù„Ø§', chars: ['Ù‰', 'Ù„Ø§'], fingers: 'Index fingers (lower row)' },
    { name: 'Ùˆ-Ø¤', chars: ['Ùˆ', 'Ø¤'], fingers: 'Middle fingers (lower row)' },
    { name: 'Ø²-Ø¡', chars: ['Ø²', 'Ø¡'], fingers: 'Ring fingers (lower row)' },
    { name: 'Ø¸-Ø¦', chars: ['Ø¸', 'Ø¦'], fingers: 'Pinky fingers (lower row)' },
  ];

  // Legacy lessons (kept for compatibility)
  const LETTER_LESSONS = [
    { id:'L1A', name:'Index Right (Øª Ø¨ Ù„ Ø§)', chars:[...'ØªØ¨Ù„Ø§'] },
    { id:'L1B', name:'Index Left (Ø´ Ø³ ÙŠ)', chars:[...'Ø´Ø³ÙŠ'] },
    { id:'L1C', name:'Both Index Mix', chars:[...'ØªØ¨Ù„Ø§Ø´Ø³ÙŠ'] },
    { id:'L1D', name:'Middle/Ring/Pinky Mix', chars:[...'Ù†Ù…Ù…ÙƒØ·Ø¯Ø¯Ø¬Ø­Ø®Ù‡Ø¹ØºÙÙ‚'] },
    { id:'L1E', name:'All Core Letters', chars: uniqueChars(ARABIC_KEYBOARD_ROWS.flat().join('')) }
  ];

  const WORD_BANK = [
    'Ø¨Ø§Ø¨','Ø¨ÙŠØª','Ù…Ø§Ø¡','Ù†ÙˆØ±','Ù‚Ù…Ø±','Ø´Ù…Ø³','ÙƒØªØ§Ø¨','Ù…Ø¯Ø±Ø³Ø©','Ø·Ø±ÙŠÙ‚','Ù‚Ù„Ø¨','Ø³Ù‡Ù„','ÙˆØ±Ø¯Ø©','Ø³Ù…Ùƒ','Ù‚Ù„Ù…','ÙˆÙ‚Øª'
  ];

  const TEXT_BANK = [
    'Ø®ÙŽØ±ÙŽØ¬ÙŽ Ø¬ÙØ­ÙŽØ§ Ù„ÙŽÙŠÙ’Ù„Ù‹Ø§ ÙÙŽØ³ÙŽÙ…ÙØ¹ÙŽ ØµÙŽÙˆÙ’ØªÙ‹Ø§ØŒ ÙÙŽÙ‚ÙŽØ§Ù„ÙŽ: Ù…ÙŽÙ†Ù’ Ù‡ÙÙ†ÙŽØ§ÙƒÙŽØŸ ÙÙŽÙ‚ÙŽØ§Ù„ÙŽ Ø§Ù„Ù„ÙÙ‘ØµÙÙ‘: Ø£ÙŽÙ†ÙŽØ§ Ø§Ù„Ø±ÙÙ‘ÙŠØ­Ù. ÙÙŽÙ‚ÙŽØ§Ù„ÙŽ Ø¬ÙØ­ÙŽØ§: Ø³ÙŽÙˆÙ’ÙÙŽ Ø£ÙØºÙ’Ù„ÙÙ‚Ù Ø§Ù„Ù’Ø¨ÙŽØ§Ø¨ÙŽ Ù‚ÙŽØ¨Ù’Ù„ÙŽ Ø£ÙŽÙ†Ù’ ØªÙŽØ¯Ù’Ø®ÙÙ„ÙŽ!'
  ];

  // --- DOM
  const els = {
    keyboard: document.getElementById('keyboard'),
    textDisplay: document.getElementById('textDisplay'),
    progressFill: document.getElementById('progressFill'),
    acc: document.getElementById('acc'),
    wpm: document.getElementById('wpm'),
    hits: document.getElementById('hits'),
    miss: document.getElementById('miss'),
    timer: document.getElementById('timer'),
    mode: document.getElementById('mode'),
    lesson: document.getElementById('lesson'),
    pairDisplay: document.getElementById('pairDisplay'),
    pairSelector: document.getElementById('pairSelector'),
    length: document.getElementById('length'),
    startBtn: document.getElementById('startBtn'),
    pauseBtn: document.getElementById('pauseBtn'),
    resetBtn: document.getElementById('resetBtn'),
  };

  // --- State
  const state = {
    mode: 'letters',
    lesson: LETTER_LESSONS[0],
    selectedPairIndex: 0, // For progressive pair selection
    sequence: '',
    index: 0,
    hits: 0,
    miss: 0,
    startedAt: null,
    pausedAt: null,
    running: false,
    awaitingAdvancement: false,
    keyIndex: new Map(),
    ticker: null,
  };

  // --- Init
  renderKeyboard();
  populateLessons();
  bindControls();
  resetSession();

  function renderKeyboard(){
    els.keyboard.innerHTML = '';
    state.keyIndex.clear();
    ARABIC_KEYBOARD_ROWS.forEach(rowChars => {
      const row = document.createElement('div');
      row.className = 'row';
      rowChars.forEach(ch => {
        const key = document.createElement('div');
        key.className = 'key';
        key.dataset.char = ch;
        key.innerHTML = `<span class="label">${escapeHtml(ch)}</span>`;
        row.appendChild(key);
        state.keyIndex.set(ch, key);
      });
      els.keyboard.appendChild(row);
    });
  }

  function populateLessons(){
    if(state.mode === 'letters'){
      // Show progressive pair selector
      els.lesson.style.display = 'none';
      els.pairDisplay.style.display = 'block';
      renderPairDisplay();
      renderPairSelector();
    } else {
      // Show traditional dropdown
      els.lesson.style.display = 'block';
      els.pairDisplay.style.display = 'none';
      els.pairSelector.style.display = 'none';
      els.lesson.innerHTML = '';
      
      if(state.mode === 'words'){
        addOption(els.lesson, 'W1', 'Basic Words');
      } else if(state.mode === 'texts'){
        addOption(els.lesson, 'T1', 'Juha â€” Short Excerpt');
      }
      els.lesson.selectedIndex = 0;
    }
  }

  function renderPairDisplay(){
    els.pairDisplay.innerHTML = '';
    const selectedPair = LETTER_PAIRS[state.selectedPairIndex];
      const item = document.createElement('div');
      item.className = 'pair-item';
      item.innerHTML = `
      <div class="pair-name">${selectedPair.name}</div>
      <div class="pair-desc">${selectedPair.fingers}</div>
      `;
    els.pairDisplay.appendChild(item);
    // Add hover event listeners
    els.pairDisplay.addEventListener('mouseenter', showPairSelector);
    els.pairDisplay.addEventListener('mouseleave', hidePairSelector);
  }
  
  function showPairSelector(){
    console.debug("showing selector")
    
    // Get the position of the pair display element
    const displayRect = els.pairDisplay.getBoundingClientRect();
    const containerRect = els.pairDisplay.offsetParent.getBoundingClientRect();
    
    // Calculate position relative to the container
    const top = displayRect.top - containerRect.top;
    const left = displayRect.left - containerRect.left;
    
    // Position the selector
    els.pairSelector.style.top = top + 'px';
    els.pairSelector.style.left = left + 'px';
    
    els.pairSelector.classList.add('show');
    // Also listen for mouse leave on selector itself
    els.pairSelector.addEventListener('mouseleave', hidePairSelector);
  }
  
  function hidePairSelector(e){
    // Only hide if not moving to the selector
    if(!e.relatedTarget || (!els.pairDisplay.contains(e.relatedTarget) && !els.pairSelector.contains(e.relatedTarget))){
      els.pairSelector.classList.remove('show');
    }
  }

  function renderPairSelector(){
    els.pairSelector.innerHTML = '';
    
    LETTER_PAIRS.forEach((pair, index) => {
      const item = document.createElement('div');
      item.className = 'pair-item';
      item.dataset.index = index;
      
      if(index === state.selectedPairIndex) {
        item.classList.add('selected');
      }
      
      item.innerHTML = `
        <div class="pair-name">${pair.name}</div>
        <div class="pair-desc">${pair.fingers}</div>
      `;
      
      // Hover event for progressive selection
      item.addEventListener('mouseenter', () => {
        updatePairPreview(index);
      });
      
      // Click event for selection
      item.addEventListener('click', () => {
        selectPair(index);
      });
      
      els.pairSelector.appendChild(item);
    });
  }

  function updatePairPreview(hoverIndex){
    const items = els.pairSelector.querySelectorAll('.pair-item');
    items.forEach((item, index) => {
      item.classList.remove('active');
      if(index <= hoverIndex) {
        item.classList.add('active');
      }
    });
  }

  function selectPair(pairIndex){
    state.selectedPairIndex = pairIndex;
    renderPairDisplay();
    renderPairSelector();
    resetSession();
  }

  function addOption(sel, value, label){
    const opt = document.createElement('option');
    opt.value = value; opt.textContent = label; sel.appendChild(opt);
  }

  function bindControls(){
    els.mode.addEventListener('change', () => {
      state.mode = els.mode.value;
      populateLessons();
      resetSession();
    });

    els.lesson.addEventListener('change', () => {
      if(state.mode === 'letters'){
        const id = els.lesson.value;
        state.lesson = LETTER_LESSONS.find(l=>l.id===id) || LETTER_LESSONS[0];
      }
      resetSession();
    });

    els.length.addEventListener('change', () => resetSession());

    els.startBtn.addEventListener('click', startDrill);
    els.pauseBtn.addEventListener('click', togglePause);
    els.resetBtn.addEventListener('click', resetSession);

    window.addEventListener('keydown', onKeyDown);
  }

  // --- Session control
  function resetSession(){
    state.sequence = '';
    state.index = 0;
    state.hits = 0;
    state.miss = 0;
    state.startedAt = null;
    state.pausedAt = null;
    state.running = false;
    state.awaitingAdvancement = false;
    stopTicker();
    updateStats();
    renderSequencePlaceholder();
    updateProgress();
    clearKeyFeedback();
  }
  
  function advanceToNextLevel(){
    if(state.selectedPairIndex < LETTER_PAIRS.length - 1){
      state.selectedPairIndex++;
      renderPairDisplay();
      renderPairSelector();
      state.awaitingAdvancement = false;
      resetSession();
    }
  }

  function startDrill(){
    const len = parseInt(els.length.value, 10);
    if(state.mode === 'letters'){
      // Use progressive pairs system
      const availableChars = getProgressiveChars(state.selectedPairIndex);
      state.sequence = createLettersDrill(availableChars, len);
    } else if(state.mode === 'words'){
      state.sequence = createWordsDrill(WORD_BANK, Math.max(6, Math.floor(len/3)));
    } else {
      state.sequence = pickText(TEXT_BANK);
    }

    state.index = 0;
    state.hits = 0;
    state.miss = 0;
    state.startedAt = performance.now();
    state.pausedAt = null;
    state.running = true;
    startTicker();
    renderSequence();
    updateProgress();
    previewNextKey();
  }

  function togglePause(){
    if(!state.running && state.startedAt){
      // resume
      state.running = true;
      if(state.pausedAt){
        const pausedMs = performance.now() - state.pausedAt;
        state.startedAt += pausedMs; // shift start so elapsed excludes pause
      }
      startTicker();
      previewNextKey();
      return;
    }
    if(state.running){
      state.running = false;
      state.pausedAt = performance.now();
      stopTicker();
      clearPreviews();
    }
  }

  function startTicker(){ stopTicker(); state.ticker = setInterval(updateStats, 120); }
  function stopTicker(){ if(state.ticker){ clearInterval(state.ticker); state.ticker = null; } }

  // --- Progressive Character Selection
  function getProgressiveChars(maxPairIndex){
    const chars = new Set();
    for(let i = 0; i <= maxPairIndex; i++){
      LETTER_PAIRS[i].chars.forEach(ch => chars.add(ch));
    }
    return [...chars];
  }

  // --- Drill Generators
  function createLettersDrill(charset, length){
    const out = [];
    for(let i=0;i<length;i++){
      out.push( pick(charset) );
    }
    return out.join(' ');
  }
  function createWordsDrill(words, count){
    const chosen = [];
    for(let i=0;i<count;i++) chosen.push(pick(words));
    return chosen.join(' ');
  }
  function pickText(texts){ return pick(texts); }
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  // --- Rendering
  function renderSequence(){
    const s = state.sequence; const i = state.index;
    const before = escapeHtml(s.slice(0,i));
    const cur = s[i] ? escapeHtml(s[i]) : '';
    const after = escapeHtml(s.slice(i+1));
    els.textDisplay.innerHTML = `${before}<span class="cursor">${cur}</span>${after}`;
  }
  function renderSequencePlaceholder(){ els.textDisplay.textContent = 'Press "Enter" to begin.'; }

  function updateProgress(){
    const total = Math.max(state.sequence.length, 1);
    const pct = (state.index / total) * 100;
    //els.progressFill.style.width = pct + '%';
  }

  function updateStats(){
    const total = state.hits + state.miss;
    const acc = total ? Math.round((state.hits/total)*100) : 0;
    els.acc.textContent = acc + '%';

    const elapsedMs = state.startedAt ? (performance.now() - state.startedAt) : 0;
    const elapsedMin = Math.max(elapsedMs/60000, 1/60000);
    const wpm = Math.round(((state.hits)/5) / elapsedMin);
    els.wpm.textContent = String(wpm);

    els.hits.textContent = String(state.hits);
    els.miss.textContent = String(state.miss);
    els.timer.textContent = (elapsedMs/1000).toFixed(1) + 's';
  }

  // --- Input Handling
  function onKeyDown(ev){
    console.debug('keydown check');
    if(!state.running) return;

    const key = (ev.key === ' ') ? ' ' : ev.key; // allow space
    const mapped = KEYMAP[key];

    // Backspace: optional stepping back
    if(ev.key === 'Backspace'){
      if(state.index>0) state.index--;
      renderSequence(); updateProgress(); previewNextKey();
      return;
    }

    // Ignore if not mapped and not space
    if(mapped === undefined && key !== ' ') return;

    const expected = state.sequence[state.index];
    const inputChar = (key === ' ') ? ' ' : mapped;

    if(inputChar === expected){
      state.hits++;
      flashKey(inputChar, true);
      state.index++;
      if (state.mode === 'letters') {
        state.index++;
      }
      renderSequence(); updateProgress();
      if(state.index >= state.sequence.length){ finish(); return; }
      previewNextKey();
    } else {
      state.miss++;
      flashKey(inputChar, false);
      // softly hint the expected key
      hintExpected(expected);
    }

    updateStats();
  }

  function finish(){
    state.running = false; stopTicker(); clearPreviews();
    // celebratory glow for used keys
    new Set([...state.sequence]).forEach(ch => flashTransient(ch, 'glow', 420));
    
    // Show congratulations for letter mode
    if(state.mode === 'letters'){
      showCongratulations();
    }
  }
  
  function showCongratulations(){
    const canAdvance = state.selectedPairIndex < LETTER_PAIRS.length - 1;
    const message = canAdvance ? 
      'Great job! Press Enter to advance to the next level.' :
      'Congratulations! You\'ve completed all levels!';
    
    els.textDisplay.innerHTML = `
      <div style="text-align: center; color: var(--ok); font-size: 24px; margin: 20px 0;">
        ðŸŽ‰ Exercise Complete! ðŸŽ‰
      </div>
      <div style="text-align: center; font-size: 18px;">
        ${message}
      </div>
    `;
    
    state.awaitingAdvancement = canAdvance;
  }

  // --- Keyboard Feedback
  function flashKey(ch, ok){
    const el = state.keyIndex.get(ch);
    if(!el) return; // space or non-key
    el.classList.add('press');
    el.classList.add(ok ? 'ok' : 'bad');
    setTimeout(()=>{ el.classList.remove('press','ok','bad'); }, 180);
  }
  function hintExpected(ch){
    const el = state.keyIndex.get(ch);
    if(!el) return;
    el.classList.add('glow'); setTimeout(()=> el.classList.remove('glow'), 260);
  }
  function previewNextKey(){
    clearPreviews();
    const ch = state.sequence[state.index];
    const el = state.keyIndex.get(ch);
    if(el) el.classList.add('glow');
  }
  function clearPreviews(){ state.keyIndex.forEach(el=> el.classList.remove('glow')); }
  function clearKeyFeedback(){ state.keyIndex.forEach(el => el.classList.remove('ok','bad','press','glow')); }
  function flashTransient(ch, cls, ms){ const el = state.keyIndex.get(ch); if(!el) return; el.classList.add(cls); setTimeout(()=>el.classList.remove(cls), ms); }

  // --- Utils
  function escapeHtml(str){ return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function uniqueChars(s){ return [...new Set([...s].filter(Boolean))]; }

  // Accessibility shortcuts
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && !state.running) {
      e.preventDefault();
      e.stopPropagation();
      if(state.awaitingAdvancement && state.mode === 'letters'){
        advanceToNextLevel();
        startDrill();
      } else {
        startDrill();
      }
    }
    if(e.key === 'Escape') {
      e.preventDefault();
      e.stopPropagation();
      resetSession();
    }
  });

  // Focus to capture keys reliably
  window.addEventListener('load', ()=>{ document.body.tabIndex = -1; document.body.focus(); });
  </script>
</body>
</html>
